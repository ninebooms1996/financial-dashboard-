<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>บริษัท รับทรัพย์โชคทวีจำกัด — Financial Dashboard</title>

  <!-- Base UI -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">

  <!-- Thai fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600;700;800&family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --glass: rgba(255,255,255,.08); }
    body{ background:#0b1020; font-family:"Noto Sans Thai",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    .hidden{ display:none!important }
    .badge{ padding:.25rem .5rem;border-radius:999px;background:rgba(255,255,255,.1);font-size:.75rem }
    .mono{ font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace }
    .positive{ color:#16a34a;font-weight:600 } .negative{ color:#dc2626;font-weight:600 }
    .pill{ border:1px solid var(--pico-muted-border-color); border-radius:999px; padding:.4rem .75rem }
    .table-wrap{ overflow:auto; max-height:50vh }

    /* ===== Login screen ===== */
    .login-screen{
      min-height:100dvh; display:grid; place-items:center;
      background:
        radial-gradient(50% 50% at 15% 15%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(50% 50% at 85% 15%, rgba(14,165,233,.16), transparent 60%),
        radial-gradient(50% 50% at 50% 85%, rgba(14,165,233,.10), transparent 60%),
        #0b1020;
      padding:24px;
    }
    .login-card{
      width:100%; max-width:560px; padding:32px 28px; border-radius:18px;
      background:rgba(15,23,42,.9); border:1px solid var(--glass);
      box-shadow:0 20px 40px rgba(2,6,23,.6); color:#e5e7eb; text-align:center;
    }

    /* ชื่อบริษัท: ตัวขาว-ขอบดำ บรรทัดเดียว */
    .company-name{
      font-family:"Kanit","Noto Sans Thai",sans-serif;
      margin:4px 0 8px 0; font-weight:800; letter-spacing:.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:clamp(24px,3.8vw,34px);
      -webkit-text-fill-color:#fff;
      -webkit-text-stroke:1.2px #000;
      color:#fff;
      text-shadow:-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
      cursor:pointer;
    }

    /* ป้าย “รายรับรายจ่าย” วางเหนือปุ่ม Google ชิดกัน */
    .tag-pill{
      display:inline-block;
      padding:.35rem .9rem;
      border:2px solid #fff; border-radius:999px;
      background:transparent; color:#fff;
      font-weight:700; letter-spacing:.4px;
      font-family:"Kanit","Noto Sans Thai",sans-serif;
      margin: 6px auto 8px; /* ชิดด้านบนของปุ่ม */
    }

    /* ปุ่ม Google: พื้นดำ ขอบขาว */
    .btn-google{
      all: unset;
      display:inline-flex; align-items:center; justify-content:center; gap:.6rem;
      padding:.95rem 1.2rem; background:#000; color:#fff;
      border:2px solid #fff; border-radius:12px; font-weight:800; letter-spacing:.3px;
      cursor:pointer; user-select:none; margin-top:0;
    }
    .btn-google:hover{ opacity:.9; }
    .btn-google:focus-visible{ outline:2px solid #fff; outline-offset:3px; }
    .gmark{ width:18px; height:18px; }

    /* ===== Dashboard look ===== */
    .app-shell{ max-width:1100px }
    .app-surface{ background:#0f172a; color:#e5e7eb; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px 18px }
    .card-inset{ background:#0b1324; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px 14px }
    table{ color:#e5e7eb } th{ background:#0b1324 }
  </style>
</head>
<body>

<!-- ======================= LOGIN ======================= -->
<section id="loginSection" class="login-screen">
  <article class="login-card">
    <!-- ไม่มีโลโก้/กล่องอื่น -->
    <h2 id="companyTitle" class="company-name" title="คลิกเพื่อเปลี่ยนชื่อบริษัท"></h2>
    <div class="tag-pill" id="tagLine">รายรับรายจ่าย</div>
    <button id="btnSignIn" class="btn-google">
      <img class="gmark" alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
      SIGN IN WITH GOOGLE
    </button>
  </article>
</section>

<!-- ======================= DASHBOARD ======================= -->
<main id="dashboard" class="container app-shell hidden">
  <header class="grid" style="align-items:center">
    <div>
      <h1 id="dashboardTitle" style="margin-bottom:.25rem">Financial Dashboard — </h1>
      <small>บันทึกรายรับ-รายจ่าย • Export สำหรับยื่นบัญชี • Realtime ด้วย Firebase</small>
    </div>
    <div style="display:flex; gap:.5rem; justify-content:flex-end; align-items:center">
      <span id="userBadge" class="badge hidden"></span>
      <button id="btnSignOut" class="secondary">ออกจากระบบ</button>
    </div>
  </header>

  <!-- Controls -->
  <section class="app-surface">
    <div class="grid">
      <div>
        <label>ชื่อบริษัท
          <input id="companyName" type="text" placeholder="เช่น บริษัท เอ บี ซี จำกัด" />
        </label>
        <small>ใช้เป็นชื่อในรายงาน และเป็นแฟ้มใน Firestore</small>
      </div>
      <div>
        <label>รอบบัญชี (เดือน)
          <input id="monthPicker" type="month" required>
        </label>
      </div>
      <div style="display:flex; align-items:end; gap:.5rem">
        <button id="btnApply" class="primary">โหลดข้อมูล</button>
        <button id="btnExportCSV" class="secondary">Export CSV</button>
        <button id="btnExportPDF" class="secondary">Export PDF</button>
        <button id="btnPrint" class="secondary">พิมพ์รายงาน</button>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section>
    <div class="grid">
      <article class="card-inset"><hgroup><h3>รายรับเดือนนี้</h3><h2 class="positive mono" id="kpiIncome">฿0.00</h2></hgroup></article>
      <article class="card-inset"><hgroup><h3>รายจ่ายเดือนนี้</h3><h2 class="negative mono" id="kpiExpense">฿0.00</h2></hgroup></article>
      <article class="card-inset"><hgroup><h3>คงเหลือ (สุทธิ)</h3><h2 class="mono" id="kpiNet">฿0.00</h2></hgroup></article>
    </div>
  </section>

  <!-- Chart -->
  <section>
    <article class="card-inset">
      <header><h3 style="margin:0">กราฟรายวัน: รายรับ vs รายจ่าย</h3><small id="periodLabel" class="muted"></small></header>
      <canvas id="dailyChart" height="140"></canvas>
    </article>
  </section>

  <!-- Add transaction -->
  <section>
    <article class="card-inset">
      <h3 style="margin-top:0">บันทึกรายการใหม่</h3>
      <form id="txForm">
        <div class="grid">
          <label>วันที่-เวลา <input id="txDate" type="datetime-local" required></label>
          <label>ประเภท
            <select id="txType" required><option value="income">รายรับ</option><option value="expense">รายจ่าย</option></select>
          </label>
          <label>หมวดหมู่
            <select id="txCategory" required>
              <option>Sales</option><option>Service</option><option>Salary</option>
              <option>Rent</option><option>Utilities</option><option>Supplies</option><option>Other</option>
            </select>
          </label>
          <label>จำนวนเงิน (บาท) <input id="txAmount" type="number" step="0.01" min="0" required></label>
        </div>
        <label>หมายเหตุ <input id="txNote" type="text" placeholder="รายละเอียดเพิ่มเติม (ไม่บังคับ)"></label>
        <div class="pill" id="txMsg" style="display:inline-block"></div>
        <button type="submit" class="primary" style="margin-top:.5rem">บันทึก</button>
      </form>
    </article>
  </section>

  <!-- Table -->
  <section>
    <article class="card-inset">
      <header class="grid">
        <div><h3 style="margin:0">รายการเดือนนี้</h3><small id="countLabel" class="muted">0 รายการ</small></div>
        <div style="display:flex;justify-content:flex-end"><input id="searchBox" class="pill" placeholder="ค้นหา: หมวด/หมายเหตุ…"></div>
      </header>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>วันที่</th><th>เวลา</th><th>ประเภท</th><th>หมวด</th><th style="text-align:right">จำนวนเงิน</th><th>หมายเหตุ</th><th></th></tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </article>
  </section>

  <footer style="margin:1.5rem 0">
    <small>Project: <b>financial dashboard</b> • Project ID: <b>financial-dashboard-3d5dc</b> • Firestore & Auth (Google)</small>
  </footer>
</main>

<!-- Firebase & Chart.js -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
/* =============== Firebase =============== */
const firebaseConfig={ apiKey:"AIzaSyC1--Ek-zl4wx5yOa7rvkNhldKWG7hIjjo", authDomain:"financial-dashboard-3d5dc.firebaseapp.com", projectId:"financial-dashboard-3d5dc" };
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();

/* =============== Refs =============== */
const $=id=>document.getElementById(id);
const loginSection=$('loginSection'), dashboard=$('dashboard');
const btnSignIn=$('btnSignIn'), btnSignOut=$('btnSignOut'), userBadge=$('userBadge');
const companyTitle=$('companyTitle'), dashboardTitle=$('dashboardTitle');
const companyName=$('companyName'), monthPicker=$('monthPicker'), btnApply=$('btnApply');
const kpiIncome=$('kpiIncome'), kpiExpense=$('kpiExpense'), kpiNet=$('kpiNet'), periodLabel=$('periodLabel');
const txForm=$('txForm'), txDate=$('txDate'), txType=$('txType'), txCategory=$('txCategory'), txAmount=$('txAmount'), txNote=$('txNote'), txMsg=$('txMsg');
const txBody=$('txBody'), countLabel=$('countLabel'), searchBox=$('searchBox');
const btnExportCSV=$('btnExportCSV'), btnExportPDF=$('btnExportPDF'), btnPrint=$('btnPrint');

/* =============== State/Utils =============== */
let currentUser=null, unsubscribe=null, txCache=[], chart=null;
const pad2=n=>String(n).padStart(2,'0');
const fmtBaht=n=>'฿'+(Number(n||0)).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});
const toLocalDateTimeInput=d=>{const t=new Date(d);return `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}T${pad2(t.getHours())}:${pad2(t.getMinutes())}`};
const monthRange=yyyyMM=>{const [y,m]=yyyyMM.split('-').map(Number);return{start:new Date(y,m-1,1,0,0,0,0),end:new Date(y,m,1,0,0,0,0)}};
// support Thai names in path: replace spaces and block invalid chars
const sanitizeId=s=>(s||'default').trim().replace(/[\/#?\[\]]/g,'-').replace(/\s+/g,'-');

/* =============== Company name: load/edit/sync =============== */
function getQueryCompany(){
  const p=new URLSearchParams(location.search).get('company');
  return p ? decodeURIComponent(p) : null;
}
const DEFAULT_COMPANY='บริษัท รับทรัพย์โชคทวีจำกัด';
function setCompanyName(name){
  const n=(name||'').trim()||DEFAULT_COMPANY;
  companyTitle.textContent=n;
  localStorage.setItem('companyNameTitle', n);
  document.title=`${n} — Financial Dashboard`;
  if(companyName && (!companyName.value || companyName.value===DEFAULT_COMPANY)) companyName.value=n;
  dashboardTitle.textContent=`Financial Dashboard — ${n}`;
}
setCompanyName(getQueryCompany() || localStorage.getItem('companyNameTitle') || DEFAULT_COMPANY);
companyTitle.addEventListener('click', ()=>{
  const v=prompt('ตั้งชื่อบริษัทใหม่', companyTitle.textContent.trim());
  if(v!==null){ setCompanyName(v); localStorage.setItem('companyName', v); }
});

/* =============== Firestore path =============== */
function getTxCollectionRef(){
  const comp=sanitizeId(companyName.value);
  return db.collection('users').doc(currentUser.uid).collection('companies').doc(comp).collection('transactions');
}

/* =============== Auth =============== */
btnSignIn.addEventListener('click', async ()=>{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); });
btnSignOut.addEventListener('click', async ()=>{ if(unsubscribe){unsubscribe();unsubscribe=null;} await auth.signOut(); });

auth.onAuthStateChanged(user=>{
  currentUser=user||null;
  if(user){
    userBadge.textContent=user.displayName||user.email;
    loginSection.classList.add('hidden'); dashboard.classList.remove('hidden');

    const defaultCompany=localStorage.getItem('companyNameTitle')||DEFAULT_COMPANY;
    companyName.value=localStorage.getItem('companyName')||defaultCompany;
    monthPicker.value=localStorage.getItem('monthPicker')||new Date().toISOString().slice(0,7);
    dashboardTitle.textContent=`Financial Dashboard — ${companyName.value}`;
    txDate.value=toLocalDateTimeInput(new Date());
    applyAndListen();
  }else{
    dashboard.classList.add('hidden'); loginSection.classList.remove('hidden');
  }
});

/* live sync title when input changed in dashboard */
companyName?.addEventListener('input', ()=>{
  const n=(companyName.value||'').trim()||DEFAULT_COMPANY;
  dashboardTitle.textContent=`Financial Dashboard — ${n}`;
  localStorage.setItem('companyNameTitle', n);
});

/* =============== Load / Realtime =============== */
btnApply.addEventListener('click', applyAndListen);
function applyAndListen(){
  if(!currentUser) return;
  localStorage.setItem('companyName', companyName.value.trim());
  localStorage.setItem('monthPicker', monthPicker.value);

  if(unsubscribe){unsubscribe();unsubscribe=null;}
  const {start,end}=monthRange(monthPicker.value);
  periodLabel.textContent=`ช่วง ${start.toLocaleDateString('th-TH')} – ${new Date(end-1).toLocaleDateString('th-TH')}`;

  unsubscribe=getTxCollectionRef()
    .where('date','>=',start).where('date','<',end).orderBy('date','asc')
    .onSnapshot(snap=>{
      txCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderTable(); renderKPIs(); renderChart();
    }, err=>alert('โหลดข้อมูลผิดพลาด: '+err.message));
}

/* =============== Add transaction =============== */
txForm.addEventListener('submit', async e=>{
  e.preventDefault(); if(!currentUser) return;
  const data={ uid:currentUser.uid, company:companyName.value.trim(), type:txType.value, category:txCategory.value,
    amount:Number(txAmount.value||0), note:txNote.value.trim(), date:new Date(txDate.value),
    createdAt:new Date(), createdBy:currentUser.email||currentUser.uid };
  txMsg.textContent='...กำลังบันทึก';
  try{
    await getTxCollectionRef().add(data);
    txMsg.textContent='บันทึกแล้ว ✓';
    txAmount.value=''; txNote.value=''; txDate.value=toLocalDateTimeInput(new Date());
    setTimeout(()=>txMsg.textContent='',1200);
  }catch(err){ txMsg.textContent='ผิดพลาด: '+err.message; }
});

/* =============== Table =============== */
searchBox.addEventListener('input', renderTable);
function renderTable(){
  const q=(searchBox.value||'').toLowerCase();
  const rows=txCache.filter(r=>!q||(r.category||'').toLowerCase().includes(q)||(r.note||'').toLowerCase().includes(q));
  countLabel.textContent=`${rows.length} รายการ`;
  txBody.innerHTML=rows.map(r=>{
    const d=new Date(r.date.seconds ? r.date.seconds*1000 : r.date);
    const amount=(r.type==='expense'?'-':'')+fmtBaht(r.amount);
    return `<tr>
      <td>${d.toLocaleDateString('th-TH')}</td>
      <td>${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</td>
      <td>${r.type==='income'?'รายรับ':'รายจ่าย'}</td>
      <td>${r.category}</td>
      <td style="text-align:right" class="mono ${r.type==='income'?'positive':'negative'}">${amount}</td>
      <td>${r.note||''}</td>
      <td style="text-align:right"><button class="secondary outline" data-del="${r.id}">ลบ</button></td>
    </tr>`;
  }).join('');
  [...document.querySelectorAll('[data-del]')].forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('ต้องการลบรายการนี้?')) return;
      try{ await getTxCollectionRef().doc(btn.dataset.del).delete(); }catch(err){ alert('ลบไม่ได้: '+err.message); }
    });
  });
}

/* =============== KPIs =============== */
function renderKPIs(){
  const income=txCache.filter(r=>r.type==='income').reduce((s,r)=>s+Number(r.amount||0),0);
  const expense=txCache.filter(r=>r.type==='expense').reduce((s,r)=>s+Number(r.amount||0),0);
  const net=income-expense;
  kpiIncome.textContent=fmtBaht(income); kpiExpense.textContent=fmtBaht(expense);
  kpiNet.textContent=(net>=0?'':'-')+fmtBaht(Math.abs(net));
}

/* =============== Chart =============== */
function renderChart(){
  const {start}=monthRange(monthPicker.value);
  const days=new Date(start.getFullYear(), start.getMonth()+1, 0).getDate();
  const labels=[...Array(days)].map((_,i)=>String(i+1));
  const incomeDaily=Array(days).fill(0), expenseDaily=Array(days).fill(0);
  txCache.forEach(r=>{
    const d=new Date(r.date.seconds ? r.date.seconds*1000 : r.date);
    const i=d.getDate()-1;
    if(r.type==='income') incomeDaily[i]+=Number(r.amount||0); else expenseDaily[i]+=Number(r.amount||0);
  });
  const ctx=document.getElementById('dailyChart'); if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'รายรับ',data:incomeDaily},{label:'รายจ่าย',data:expenseDaily}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});
}

/* =============== Export =============== */
function toCSV(){
  const {start,end}=monthRange(monthPicker.value);
  const header=['Company','PeriodStart','PeriodEnd','Date','Time','Type','Category','Amount','Note','CreatedBy'];
  const lines=[header.join(',')];
  txCache.forEach(r=>{
    const d=new Date(r.date.seconds ? r.date.seconds*1000 : r.date);
    const date=[d.getFullYear(),pad2(d.getMonth()+1),pad2(d.getDate())].join('-');
    const time=[pad2(d.getHours()),pad2(d.getMinutes())].join(':');
    lines.push([
      `"${(companyName.value||'').replace(/"/g,'""')}"`,
      start.toISOString(), end.toISOString(), date, time, r.type,
      `"${(r.category||'').replace(/"/g,'""')}"`,
      Number(r.amount||0), `"${(r.note||'').replace(/"/g,'""')}"`, `"${(r.createdBy||'').replace(/"/g,'""')}"`
    ].join(','));
  }); return lines.join('\n');
}
function download(filename,text,type='text/plain'){ const blob=new Blob([text],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
btnExportCSV.addEventListener('click', ()=> download(`export_${sanitizeId(companyName.value)}_${monthPicker.value}.csv`, toCSV(), 'text/csv;charset=utf-8'));
btnExportPDF.addEventListener('click', ()=> openPrintable(true));
btnPrint.addEventListener('click', ()=> openPrintable(false));

function openPrintable(saveAsPDF){
  const {start,end}=monthRange(monthPicker.value);
  const income=txCache.filter(r=>r.type==='income').reduce((s,r)=>s+Number(r.amount||0),0);
  const expense=txCache.filter(r=>r.type==='expense').reduce((s,r)=>s+Number(r.amount||0),0);
  const net=income-expense;
  const rows=txCache.map(r=>{
    const d=new Date(r.date.seconds ? r.date.seconds*1000 : r.date);
    const sign=r.type==='expense'?'-':'';
    return `<tr>
      <td>${d.toLocaleDateString('th-TH')}</td>
      <td>${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</td>
      <td>${r.type==='income'?'รายรับ':'รายจ่าย'}</td>
      <td>${r.category}</td>
      <td style="text-align:right">${sign}${fmtBaht(r.amount)}</td>
      <td>${r.note||''}</td>
    </tr>`;
  }).join('');
  const html=`<!DOCTYPE html><html lang="th"><head><meta charset="utf-8"><title>Report — ${companyName.value||'-'}</title>
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",sans-serif;padding:24px}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px}
th{background:#f6f6f6}
.right{text-align:right}
</style></head><body>
<h2>สรุปรายรับ-รายจ่าย</h2>
<div>บริษัท: <b>${companyName.value||'-'}</b> • รอบบัญชี: ${start.toLocaleDateString('th-TH')} – ${new Date(end-1).toLocaleDateString('th-TH')}</div>
<table>
  <thead><tr><th>วันที่</th><th>เวลา</th><th>ประเภท</th><th>หมวด</th><th class="right">จำนวนเงิน</th><th>หมายเหตุ</th></tr></thead>
  <tbody>${rows || '<tr><td colspan="6">ไม่มีข้อมูล</td></tr>'}</tbody>
  <tfoot>
    <tr><td colspan="4" class="right">รวมรายรับ</td><td class="right">${fmtBaht(income)}</td><td></td></tr>
    <tr><td colspan="4" class="right">รวมรายจ่าย</td><td class="right">-${fmtBaht(expense)}</td><td></td></tr>
    <tr><td colspan="4" class="right">สุทธิ</td><td class="right">${net<0?'-':''}${fmtBaht(Math.abs(net))}</td><td></td></tr>
  </tfoot>
</table>
<script>window.addEventListener('load',()=>{ ${saveAsPDF ? 'window.print();' : ''} });<\/script>
</body></html>`;
  const w=window.open("","_blank","width=900,height=700"); w.document.open(); w.document.write(html); w.document.close();
}
</script>
</body>
</html>
