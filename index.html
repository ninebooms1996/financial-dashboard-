<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>รายรับรายจ่าย — Financial Dashboard</title>

  <!-- Base UI -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">

  <!-- Thai fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600;700;800&family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --glass: rgba(255,255,255,.1); }
    body{ background:#0b1020; color:#e5e7eb; font-family:"Noto Sans Thai",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }
    .container.app-shell{ max-width:1100px }

    .hidden{ display:none!important }
    .badge{ padding:.25rem .5rem;border-radius:999px;background:rgba(255,255,255,.12);font-size:.75rem }
    .pill{ border:1px solid var(--pico-muted-border-color); border-radius:999px; padding:.4rem .75rem }
    .mono{ font-variant-numeric:tabular-nums; font-family:ui-monospace,Menlo,Consolas,monospace }
    .positive{ color:#16a34a;font-weight:600 } .negative{ color:#dc2626;font-weight:600 }
    .app-surface{ background:#0f172a; border:1px solid var(--glass); border-radius:16px; padding:16px 18px }
    .card-inset{ background:#0b1324; border:1px solid var(--glass); border-radius:16px; padding:12px 14px }
    .table-wrap{ overflow:auto; max-height:50vh }
    table{ color:#e5e7eb } th{ background:#0b1324 }

    /* ===== Login screen ===== */
    .login-screen{
      min-height:100dvh; display:grid; place-items:center; background:#0b1020; padding:24px;
    }
    .login-card{
      width:100%; max-width:640px; padding:36px 28px; border-radius:18px;
      background:rgba(15,23,42,.9); border:1px solid var(--glass);
      box-shadow:0 20px 40px rgba(2,6,23,.6); color:#e5e7eb; text-align:center;
    }
    .title-stack{ margin-bottom:10px; text-align:center; }
    .main-title{ font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800; font-size:clamp(26px,4vw,38px);
      -webkit-text-fill-color:#fff; -webkit-text-stroke:1.4px #000; color:#fff; }
    .sub-title{ font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800; font-size:clamp(18px,2.6vw,26px);
      -webkit-text-fill-color:#fff; -webkit-text-stroke:1px #000; color:#fff; }
    .btn-google{ all: unset; cursor:pointer; padding:1rem 1.25rem; border:2px solid #fff; border-radius:12px;
      background:#000; color:#fff; font-weight:800; }

    /* ===== Dashboard header (center titles + signout link) ===== */
    .dash-header{ position:relative; text-align:center; margin:2rem auto 1rem; padding:0 1rem; }
    .dash-title-stack{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; max-width:100%; word-wrap:break-word; }
    .dash-main-title{
      font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800;
      font-size:clamp(26px,4vw,38px); text-transform:uppercase;
      -webkit-text-fill-color:#000; -webkit-text-stroke:1.4px #fff; color:#000;
    }
    .dash-sub-title{
      display:flex; flex-direction:column; align-items:center; gap:2px;
      font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800; font-size:clamp(18px,2.6vw,26px);
      -webkit-text-fill-color:#000; -webkit-text-stroke:1px #fff; color:#000;
    }
    #companyInlineEn{ font-size:clamp(15px,2.2vw,22px); font-weight:700; letter-spacing:1px; text-transform:uppercase;
      -webkit-text-fill-color:#000; -webkit-text-stroke:1px #fff; color:#000; }
    .signout-link{
      position:absolute; right:12px; top:12px; background:none; border:none; color:#fff;
      font-size:0.85rem; text-decoration:underline; cursor:pointer; opacity:.85;
    }
    .signout-link:hover{ opacity:1; }
  </style>
</head>
<body>

<!-- ======================= LOGIN ======================= -->
<section id="loginSection" class="login-screen">
  <article class="login-card">
    <div class="title-stack">
      <div class="main-title">รายรับรายจ่าย</div>
      <div id="companyTitle" class="sub-title">บริษัท รับทรัพย์โชคทวีจำกัด</div>
    </div>
    <button id="btnSignIn" class="btn-google">SIGN IN WITH GOOGLE</button>
  </article>
</section>

<!-- ======================= DASHBOARD ======================= -->
<main id="dashboard" class="container app-shell hidden">
  <header class="dash-header">
    <!-- ปุ่มออกจากระบบ: ข้อความเล็ก มุมขวาบน -->
    <button id="btnSignOut" class="signout-link">ออกจากระบบ</button>

    <!-- หัวเรื่อง 3 บรรทัด ตรงกลาง -->
    <div class="dash-title-stack">
      <div class="dash-main-title">FINANCIAL DASHBOARD</div>
      <div class="dash-sub-title">
        <div id="companyInline">บริษัท รับทรัพย์โชคทวีจำกัด</div>
        <div id="companyInlineEn">RUBSAP CHOKTAWEE CO., LTD.</div>
      </div>
    </div>

    <div style="margin-top:.5rem">
      <span id="userBadge" class="badge hidden"></span>
    </div>
  </header>

  <!-- Controls (ลบ 4 กล่องขวาออกแล้ว) -->
  <section class="app-surface">
    <div class="grid">
      <div>
        <label>ชื่อบริษัท (TH)
          <input id="companyName" type="text" placeholder="บริษัท ภาษาไทย" />
        </label>
      </div>
      <div>
        <label>Company Name (EN)
          <input id="companyNameEn" type="text" placeholder="COMPANY NAME EN" />
        </label>
      </div>
      <div>
        <label>รอบบัญชี (เดือน)
          <input id="monthPicker" type="month" required>
        </label>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section>
    <div class="grid">
      <article class="card-inset"><hgroup><h3>รายรับเดือนนี้</h3><h2 class="positive mono" id="kpiIncome">฿0.00</h2></hgroup></article>
      <article class="card-inset"><hgroup><h3>รายจ่ายเดือนนี้</h3><h2 class="negative mono" id="kpiExpense">฿0.00</h2></hgroup></article>
      <article class="card-inset"><hgroup><h3>คงเหลือ (สุทธิ)</h3><h2 class="mono" id="kpiNet">฿0.00</h2></hgroup></article>
    </div>
  </section>

  <!-- Chart -->
  <section>
    <article class="card-inset">
      <header><h3 style="margin:0">กราฟรายวัน: รายรับ vs รายจ่าย</h3><small id="periodLabel" class="muted"></small></header>
      <canvas id="dailyChart" height="140"></canvas>
    </article>
  </section>

  <!-- Add transaction (แบบเดิม) -->
  <section>
    <article class="card-inset">
      <h3 style="margin-top:0">บันทึกรายการใหม่</h3>
      <form id="txForm">
        <div class="grid">
          <label>วันที่-เวลา <input id="txDate" type="datetime-local" required></label>
          <label>ประเภท
            <select id="txType" required><option value="income">รายรับ</option><option value="expense">รายจ่าย</option></select>
          </label>
          <label>หมวดหมู่
            <select id="txCategory" required>
              <option>Sales</option><option>Service</option><option>Salary</option>
              <option>Rent</option><option>Utilities</option><option>Supplies</option><option>Other</option>
            </select>
          </label>
          <label>จำนวนเงิน (บาท) <input id="txAmount" type="number" step="0.01" min="0" required></label>
        </div>
        <label>หมายเหตุ <input id="txNote" type="text" placeholder="รายละเอียดเพิ่มเติม (ไม่บังคับ)"></label>
        <div class="pill" id="txMsg" style="display:inline-block"></div>
        <button type="submit" class="primary" style="margin-top:.5rem">บันทึก</button>
      </form>
    </article>
  </section>

  <!-- Table -->
  <section>
    <article class="card-inset">
      <header class="grid">
        <div><h3 style="margin:0">รายการเดือนนี้</h3><small id="countLabel" class="muted">0 รายการ</small></div>
        <div style="display:flex;justify-content:flex-end"><input id="searchBox" class="pill" placeholder="ค้นหา: หมวด/หมายเหตุ…"></div>
      </header>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>วันที่</th><th>เวลา</th><th>ประเภท</th><th>หมวด</th><th style="text-align:right">จำนวนเงิน</th><th>หมายเหตุ</th><th></th></tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </article>
  </section>

  <footer style="margin:1.5rem 0">
    <small>Project: <b>financial dashboard</b> • Firestore & Auth (Google)</small>
  </footer>
</main>

<!-- Firebase & Chart.js -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig={
  apiKey:"AIzaSyC1--Ek-zl4wx5yOa7rvkNhldKWG7hIjjo",
  authDomain:"financial-dashboard-3d5dc.firebaseapp.com",
  projectId:"financial-dashboard-3d5dc"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();

/* ================= Refs ================= */
const $=id=>document.getElementById(id);
const loginSection=$('loginSection'), dashboard=$('dashboard');
const btnSignIn=$('btnSignIn'), btnSignOut=$('btnSignOut'), userBadge=$('userBadge');
const companyInline=$('companyInline'), companyInlineEn=$('companyInlineEn');
const companyName=$('companyName'), companyNameEn=$('companyNameEn');
const monthPicker=$('monthPicker');
const kpiIncome=$('kpiIncome'), kpiExpense=$('kpiExpense'), kpiNet=$('kpiNet'), periodLabel=$('periodLabel');
const txForm=$('txForm'), txDate=$('txDate'), txType=$('txType'), txCategory=$('txCategory'), txAmount=$('txAmount'), txNote=$('txNote'), txMsg=$('txMsg');
const txBody=$('txBody'), countLabel=$('countLabel'), searchBox=$('searchBox');

/* ================= State/Utils ================= */
let currentUser=null, unsubscribe=null, txCache=[], chart=null;
const DEFAULT_COMPANY_TH='บริษัท รับทรัพย์โชคทวีจำกัด';
const DEFAULT_COMPANY_EN='RUBSAP CHOKTAWEE CO., LTD.';
const pad2=n=>String(n).padStart(2,'0');
const fmtBaht=n=>'฿'+(Number(n||0)).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});
const toLocalDateTimeInput=d=>{const t=new Date(d);return `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}T${pad2(t.getHours())}:${pad2(t.getMinutes())}`};
const monthRange=yyyyMM=>{const [y,m]=yyyyMM.split('-').map(Number);return{start:new Date(y,m-1,1,0,0,0,0),end:new Date(y,m,1,0,0,0,0)}};
const sanitizeId=s=>(s||'default').trim().replace(/[\/#?\[\]]/g,'-').replace(/\s+/g,'-');

/* ===== Company Name binding ===== */
function setCompanyName(th,en){
  const thName=(th||'').trim()||DEFAULT_COMPANY_TH;
  const enName=(en||'').trim()||DEFAULT_COMPANY_EN;
  companyInline.textContent = thName;
  companyInlineEn.textContent = enName.toUpperCase();
  localStorage.setItem('companyNameTH', thName);
  localStorage.setItem('companyNameEN', enName);
}
setCompanyName(localStorage.getItem('companyNameTH')||DEFAULT_COMPANY_TH,
               localStorage.getItem('companyNameEN')||DEFAULT_COMPANY_EN);

companyName.addEventListener('input',()=>setCompanyName(companyName.value,companyNameEn.value));
companyNameEn.addEventListener('input',()=>setCompanyName(companyName.value,companyNameEn.value));

/* ================= Auth ================= */
btnSignIn.addEventListener('click', async ()=>{
  try{
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }catch(e){
    if(e?.code==='auth/unauthorized-domain'){
      alert('ยังไม่ได้เพิ่มโดเมนนี้ใน Firebase:\nFirebase Console → Authentication → Settings → Authorized domains → Add domain → ' + location.host);
    }else{
      alert('ล็อกอินไม่สำเร็จ: ' + (e?.message||e));
    }
  }
});
btnSignOut.addEventListener('click', async ()=>{
  if(unsubscribe){unsubscribe();unsubscribe=null;}
  await auth.signOut();
});

auth.onAuthStateChanged(user=>{
  currentUser=user||null;
  if(user){
    userBadge.textContent=user.displayName||user.email;
    loginSection.classList.add('hidden'); dashboard.classList.remove('hidden');

    companyName.value = localStorage.getItem('companyNameTH') || DEFAULT_COMPANY_TH;
    companyNameEn.value = localStorage.getItem('companyNameEN') || DEFAULT_COMPANY_EN;
    monthPicker.value = localStorage.getItem('monthPicker') || new Date().toISOString().slice(0,7);
    companyInline.textContent = companyName.value;
    companyInlineEn.textContent = (companyNameEn.value||DEFAULT_COMPANY_EN).toUpperCase();
    txDate.value = toLocalDateTimeInput(new Date());

    applyAndListen(); // โหลดข้อมูลอัตโนมัติ
  }else{
    dashboard.classList.add('hidden'); loginSection.classList.remove('hidden');
  }
});

/* ================= Firestore path ================= */
function getTxCollectionRef(){
  const comp=sanitizeId(companyInline.textContent || DEFAULT_COMPANY_TH);
  return db.collection('users').doc(currentUser.uid).collection('companies').doc(comp).collection('transactions');
}

/* ================= Load / Realtime ================= */
monthPicker.addEventListener('change', ()=>{
  localStorage.setItem('monthPicker', monthPicker.value);
  applyAndListen();
});

function applyAndListen(){
  if(!currentUser) return;

  if(unsubscribe){unsubscribe();unsubscribe=null;}
  const {start,end}=monthRange(monthPicker.value);
  periodLabel.textContent=`ช่วง ${start.toLocaleDateString('th-TH')} – ${new Date(end-1).toLocaleDateString('th-TH')}`;

  unsubscribe=getTxCollectionRef()
    .where('date','>=',start).where('date','<',end).orderBy('date','asc')
    .onSnapshot(snap=>{
      txCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderTable(); renderKPIs(); renderChart();
    }, err=>{
      alert('โหลดข้อมูลผิดพลาด: '+err.message+
        '\n\nถ้าเห็น code 403 ให้ตรวจ Firebase Security Rules/สิทธิ์ Firestore');
    });
}

/* ================= Add transaction ================= */
txForm.addEventListener('submit', async e=>{
  e.preventDefault(); if(!currentUser) return;
  const data={
    uid:currentUser.uid,
    companyTH:companyName.value.trim()||DEFAULT_COMPANY_TH,
    companyEN:(companyNameEn.value.trim()||DEFAULT_COMPANY_EN).toUpperCase(),
    type:txType.value, category:txCategory.value,
    amount:Number(txAmount.value||0), note:txNote.value.trim(),
    date:new Date(txDate.value), createdAt:new Date(),
    createdBy:currentUser.email||currentUser.uid
  };
  txMsg.textContent='...กำลังบันทึก';
  try{
    await getTxCollectionRef().add(data);
    txMsg.textContent='บันทึกแล้ว ✓';
    txAmount.value=''; txNote.value=''; txDate.value=toLocalDateTimeInput(new Date());
    setTimeout(()=>txMsg.textContent='',1200);
  }catch(err){ txMsg.textContent='ผิดพลาด: '+err.message; }
});

/* ================= Table ================= */
searchBox.addEventListener('input', renderTable);
function renderTable(){
  const q=(searchBox.value||'').toLowerCase();
  const rows=txCache.filter(r=>!q||(r.category||'').toLowerCase().includes(q)||(r.note||'').toLowerCase().includes(q));
  countLabel.textContent=`${rows.length} รายการ`;
  txBody.innerHTML=rows.map(r=>{
    const d=new Date(r.date?.seconds ? r.date.seconds*1000 : r.date);
    const amount=(r.type==='expense'?'-':'')+fmtBaht(r.amount);
    return `<tr>
      <td>${d.toLocaleDateString('th-TH')}</td>
      <td>${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</td>
      <td>${r.type==='income'?'รายรับ':'รายจ่าย'}</td>
      <td>${r.category||''}</td>
      <td style="text-align:right" class="mono ${r.type==='income'?'positive':'negative'}">${amount}</td>
      <td>${(r.note||'')}</td>
      <td style="text-align:right"><button class="secondary outline" data-del="${r.id}">ลบ</button></td>
    </tr>`;
  }).join('');
  [...document.querySelectorAll('[data-del]')].forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('ต้องการลบรายการนี้?')) return;
      try{ await getTxCollectionRef().doc(btn.dataset.del).delete(); }
      catch(err){ alert('ลบไม่ได้: '+err.message); }
    });
  });
}

/* ================= KPIs ================= */
function renderKPIs(){
  const income=txCache.filter(r=>r.type==='income').reduce((s,r)=>s+Number(r.amount||0),0);
  const expense=txCache.filter(r=>r.type==='expense').reduce((s,r)=>s+Number(r.amount||0),0);
  const net=income-expense;
  kpiIncome.textContent=fmtBaht(income);
  kpiExpense.textContent=fmtBaht(expense);
  kpiNet.textContent=(net>=0?'':'-')+fmtBaht(Math.abs(net));
}

/* ================= Chart ================= */
function renderChart(){
  if(!monthPicker.value) return;
  const [yy,mm]=monthPicker.value.split('-').map(Number);
  const daysInMonth = new Date(yy, mm, 0).getDate();
  const labels=[...Array(daysInMonth)].map((_,i)=>String(i+1));
  const incomeDaily=Array(daysInMonth).fill(0), expenseDaily=Array(daysInMonth).fill(0);

  txCache.forEach(r=>{
    const d=new Date(r.date?.seconds ? r.date.seconds*1000 : r.date);
    const i=d.getDate()-1;
    if(i>=0 && i<daysInMonth){
      if(r.type==='income') incomeDaily[i]+=Number(r.amount||0);
      else expenseDaily[i]+=Number(r.amount||0);
    }
  });

  const ctx=document.getElementById('dailyChart');
  if(window._dailyChart){ window._dailyChart.destroy(); }
  window._dailyChart=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[
      { label:'รายรับ', data:incomeDaily },
      { label:'รายจ่าย', data:expenseDaily }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' }}, scales:{ y:{ beginAtZero:true } } }
  });
}
</script>
</body>
</html>
