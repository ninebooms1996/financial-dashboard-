<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>รายรับรายจ่าย — Financial Dashboard</title>

  <!-- Base UI -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">

  <!-- Thai fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600;700;800&family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --glass: rgba(255,255,255,.1); }
    body{ background:#0b1020; color:#e5e7eb; font-family:"Noto Sans Thai",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }
    .container.app-shell{ max-width:1100px }

    .hidden{ display:none!important }
    .badge{ padding:.25rem .5rem;border-radius:999px;background:rgba(255,255,255,.12);font-size:.75rem }
    .pill{ border:1px solid var(--pico-muted-border-color); border-radius:999px; padding:.4rem .75rem }
    .mono{ font-variant-numeric:tabular-nums; font-family:ui-monospace,Menlo,Consolas,monospace }
    .positive{ color:#16a34a;font-weight:600 } .negative{ color:#dc2626;font-weight:600 }
    .app-surface{ background:#0f172a; border:1px solid var(--glass); border-radius:16px; padding:16px 18px }
    .card-inset{ background:#0b1324; border:1px solid var(--glass); border-radius:16px; padding:12px 14px }
    .table-wrap{ overflow:auto; max-height:50vh }
    table{ color:#e5e7eb } th{ background:#0b1324 }

    /* ===== Login screen ===== */
    .login-screen{
      min-height:100dvh; display:grid; place-items:center; background:#0b1020; padding:24px;
    }
    .login-card{
      width:100%; max-width:640px; padding:36px 28px; border-radius:18px;
      background:rgba(15,23,42,.9); border:1px solid var(--glass);
      box-shadow:0 20px 40px rgba(2,6,23,.6); color:#e5e7eb; text-align:center;
    }
    .title-stack{ margin-bottom:10px; text-align:center; }
    .main-title{ font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800; font-size:clamp(26px,4vw,38px);
      -webkit-text-fill-color:#fff; -webkit-text-stroke:1.4px #000; color:#fff; }
    .sub-title{ font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800; font-size:clamp(18px,2.6vw,26px);
      -webkit-text-fill-color:#fff; -webkit-text-stroke:1px #000; color:#fff; }
    .btn-google{ all: unset; cursor:pointer; padding:1rem 1.25rem; border:2px solid #fff; border-radius:12px;
      background:#000; color:#fff; font-weight:800; }

    /* ===== Dashboard header (center titles + signout link) ===== */
    .dash-header{ position:relative; text-align:center; margin:2rem auto 1rem; padding:0 1rem; }
    .dash-title-stack{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; max-width:100%; word-wrap:break-word; }
    .dash-main-title{
      font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800;
      font-size:clamp(26px,4vw,38px); text-transform:uppercase;
      -webkit-text-fill-color:#000; -webkit-text-stroke:1.4px #fff; color:#000;
    }
    .dash-sub-title{
      display:flex; flex-direction:column; align-items:center; gap:2px;
      font-family:"Kanit","Noto Sans Thai",sans-serif; font-weight:800; font-size:clamp(18px,2.6vw,26px);
      -webkit-text-fill-color:#000; -webkit-text-stroke:1px #fff; color:#000;
    }
    #companyInlineEn{ font-size:clamp(15px,2.2vw,22px); font-weight:700; letter-spacing:1px; text-transform:uppercase;
      -webkit-text-fill-color:#000; -webkit-text-stroke:1px #fff; color:#000; }
    .signout-link{
      position:absolute; right:12px; top:12px; background:none; border:none; color:#fff;
      font-size:0.85rem; text-decoration:underline; cursor:pointer; opacity:.85;
    }
    .signout-link:hover{ opacity:1; }
  </style>
</head>
<body>

<!-- ======================= LOGIN ======================= -->
<section id="loginSection" class="login-screen">
  <article class="login-card">
    <div class="title-stack">
      <div class="main-title">รายรับรายจ่าย</div>
      <div id="companyTitle" class="sub-title">บริษัท รับทรัพย์โชคทวีจำกัด</div>
    </div>
    <button id="btnSignIn" class="btn-google">SIGN IN WITH GOOGLE</button>
  </article>
</section>

<!-- ======================= DASHBOARD ======================= -->
<main id="dashboard" class="container app-shell hidden">
  <header class="dash-header">
    <!-- ปุ่มออกจากระบบ: ข้อความเล็ก มุมขวาบน -->
    <button id="btnSignOut" class="signout-link">ออกจากระบบ</button>

    <!-- หัวเรื่อง 3 บรรทัด ตรงกลาง -->
    <div class="dash-title-stack">
      <div class="dash-main-title">FINANCIAL DASHBOARD</div>
      <div class="dash-sub-title">
        <div id="companyInline">บริษัท รับทรัพย์โชคทวีจำกัด</div>
        <div id="companyInlineEn">RUBSAP CHOKTAWEE CO., LTD.</div>
      </div>
    </div>

    <div style="margin-top:.5rem">
      <span id="userBadge" class="badge hidden"></span>
    </div>
  </header>

  <!-- Controls (ไม่มี 4 ปุ่มขวาแล้ว) -->
  <section class="app-surface">
    <div class="grid">
      <div>
        <label>ชื่อบริษัท (TH)
          <input id="companyName" type="text" placeholder="บริษัท ภาษาไทย" />
        </label>
      </div>
      <div>
        <label>Company Name (EN)
          <input id="companyNameEn" type="text" placeholder="COMPANY NAME EN" />
        </label>
      </div>
      <div>
        <label>รอบบัญชี (เดือน)
          <input id="monthPicker" type="month" required>
        </label>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section>
    <div class="grid">
      <article class="card-inset"><hgroup><h3>รายรับเดือนนี้</h3><h2 class="positive mono" id="kpiIncome">฿0.00</h2></hgroup></article>
      <article class="card-inset"><hgroup><h3>รายจ่ายเดือนนี้</h3><h2 class="negative mono" id="kpiExpense">฿0.00</h2></hgroup></article>
      <article class="card-inset"><hgroup><h3>คงเหลือ (สุทธิ)</h3><h2 class="mono" id="kpiNet">฿0.00</h2></hgroup></article>
    </div>
  </section>

  <!-- กล่องเพิ่มรายละเอียด (ใหม่) -->
  <section>
    <article class="card-inset">
      <h3 style="margin-top:0">เพิ่มรายละเอียดรายการ</h3>
      <form id="detailForm">
        <div class="grid">
          <label>วันที่-เวลา
            <input id="detDate" type="datetime-local" required>
          </label>
          <label>รหัส (Order/Doc ID)
            <input id="detOrderCode" type="text" placeholder="เช่น ORD-1234">
          </label>
          <label>เลขรหัส (Tracking/Ref)
            <input id="detRefNumber" type="text" placeholder="เช่น TRK-0001">
          </label>
          <label>ราคา
            <input id="detPrice" type="number" step="0.01" min="0" required>
          </label>
          <label>ค่าส่ง
            <input id="detShipping" type="number" step="0.01" min="0" value="0">
          </label>
          <label>ชื่อสินค้า
            <input id="detProduct" type="text" placeholder="ชื่อสินค้า/บริการ">
          </label>
          <label>ประเภท
            <select id="detType" required>
              <option value="income">รายรับ</option>
              <option value="expense">รายจ่าย</option>
            </select>
          </label>
          <label id="detExpenseWrap" class="hidden">ประเภทรายจ่ายย่อย
            <select id="detExpenseSubtype">
              <option value="ads">ค่าโฆษณา</option>
              <option value="shipping">ค่าขนส่ง</option>
              <option value="laundry">ค่าซักอบ</option>
              <option value="photo">ค่าจ้างถ่ายภาพ</option>
            </select>
          </label>
        </div>
        <label>หมายเหตุ
          <input id="detNote" type="text" placeholder="รายละเอียดเพิ่มเติม (ไม่บังคับ)">
        </label>
        <div id="detMsg" class="pill" style="display:inline-block"></div>
        <button id="detSave" type="submit" class="primary" style="margin-top:.5rem">บันทึก</button>
      </form>
    </article>
  </section>

  <!-- Chart -->
  <section>
    <article class="card-inset">
      <header><h3 style="margin:0">กราฟรายวัน: รายรับ vs รายจ่าย</h3><small id="periodLabel" class="muted"></small></header>
      <canvas id="dailyChart" height="140"></canvas>
    </article>
  </section>

  <!-- Table -->
  <section>
    <article class="card-inset">
      <header class="grid">
        <div><h3 style="margin:0">รายการเดือนนี้</h3><small id="countLabel" class="muted">0 รายการ</small></div>
        <div style="display:flex;justify-content:flex-end"><input id="searchBox" class="pill" placeholder="ค้นหา: สินค้า/รหัส/หมายเหตุ…"></div>
      </header>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>วันที่</th><th>เวลา</th><th>ประเภท</th>
              <th>ชื่อสินค้า</th><th class="right">ราคา</th><th class="right">ค่าส่ง</th>
              <th>ประเภทย่อย</th>
              <th>รหัส</th><th>เลขรหัส</th>
              <th class="right">รวม</th>
              <th>หมายเหตุ</th><th></th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </article>
  </section>

  <footer style="margin:1.5rem 0">
    <small>Project: <b>financial dashboard</b> • Firestore & Auth (Google)</small>
  </footer>
</main>

<!-- Firebase & Chart.js -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig={
  apiKey:"AIzaSyC1--Ek-zl4wx5yOa7rvkNhldKWG7hIjjo",
  authDomain:"financial-dashboard-3d5dc.firebaseapp.com",
  projectId:"financial-dashboard-3d5dc"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();

/* ================= Refs ================= */
const $=id=>document.getElementById(id);
const loginSection=$('loginSection'), dashboard=$('dashboard');
const btnSignIn=$('btnSignIn'), btnSignOut=$('btnSignOut'), userBadge=$('userBadge');
const companyInline=$('companyInline'), companyInlineEn=$('companyInlineEn');
const companyName=$('companyName'), companyNameEn=$('companyNameEn');
const monthPicker=$('monthPicker');
const kpiIncome=$('kpiIncome'), kpiExpense=$('kpiExpense'), kpiNet=$('kpiNet'), periodLabel=$('periodLabel');
const searchBox=$('searchBox'), txBody=$('txBody'), countLabel=$('countLabel');
/* Detail form */
const detailForm=$('detailForm'), detDate=$('detDate'), detOrderCode=$('detOrderCode'), detRefNumber=$('detRefNumber'),
      detPrice=$('detPrice'), detShipping=$('detShipping'), detProduct=$('detProduct'),
      detType=$('detType'), detExpenseWrap=$('detExpenseWrap'), detExpenseSubtype=$('detExpenseSubtype'),
      detNote=$('detNote'), detMsg=$('detMsg');

/* ================= State/Utils ================= */
let currentUser=null, unsubscribe=null, txCache=[], chart=null;
const DEFAULT_COMPANY_TH='บริษัท รับทรัพย์โชคทวีจำกัด';
const DEFAULT_COMPANY_EN='RUBSAP CHOKTAWEE CO., LTD.';
const pad2=n=>String(n).padStart(2,'0');
const fmtBaht=n=>'฿'+(Number(n||0)).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});
const toLocalDateTimeInput=d=>{const t=new Date(d);return `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}T${pad2(t.getHours())}:${pad2(t.getMinutes())}`};
const monthRange=yyyyMM=>{const [y,m]=yyyyMM.split('-').map(Number);return{start:new Date(y,m-1,1,0,0,0,0),end:new Date(y,m,1,0,0,0,0)}};
const sanitizeId=s=>(s||'default').trim().replace(/[\/#?\[\]]/g,'-').replace(/\s+/g,'-');

/* Helpers: read values with fallback to legacy 'amount' */
const num = v => Number(v||0);
const priceOf = r => ('price' in r ? num(r.price) : num(r.amount));
const shipOf  = r => ('shippingCost' in r ? num(r.shippingCost) : 0);
const totalSigned = r => (r.type==='expense' ? -(priceOf(r)+shipOf(r)) : priceOf(r));

/* ===== Company Name binding ===== */
function setCompanyName(th,en){
  const thName=(th||'').trim()||DEFAULT_COMPANY_TH;
  const enName=(en||'').trim()||DEFAULT_COMPANY_EN;
  companyInline.textContent = thName;
  companyInlineEn.textContent = enName.toUpperCase();
  localStorage.setItem('companyNameTH', thName);
  localStorage.setItem('companyNameEN', enName);
}
setCompanyName(localStorage.getItem('companyNameTH')||DEFAULT_COMPANY_TH,
               localStorage.getItem('companyNameEN')||DEFAULT_COMPANY_EN);

companyName.addEventListener('input',()=>setCompanyName(companyName.value,companyNameEn.value));
companyNameEn.addEventListener('input',()=>setCompanyName(companyName.value,companyNameEn.value));

/* ================= Auth ================= */
btnSignIn.addEventListener('click', async ()=>{
  try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
  catch(e){
    if(e?.code==='auth/unauthorized-domain'){
      alert('ยังไม่ได้เพิ่มโดเมนนี้ใน Firebase:\nFirebase Console → Authentication → Settings → Authorized domains → Add domain → ' + location.host);
    }else{ alert('ล็อกอินไม่สำเร็จ: ' + (e?.message||e)); }
  }
});
btnSignOut.addEventListener('click', async ()=>{ if(unsubscribe){unsubscribe();unsubscribe=null;} await auth.signOut(); });

auth.onAuthStateChanged(user=>{
  currentUser=user||null;
  if(user){
    userBadge.textContent=user.displayName||user.email;
    loginSection.classList.add('hidden'); dashboard.classList.remove('hidden');

    companyName.value = localStorage.getItem('companyNameTH') || DEFAULT_COMPANY_TH;
    companyNameEn.value = localStorage.getItem('companyNameEN') || DEFAULT_COMPANY_EN;
    monthPicker.value = localStorage.getItem('monthPicker') || new Date().toISOString().slice(0,7);
    detDate.value = toLocalDateTimeInput(new Date());

    applyAndListen(); // auto load
  }else{
    dashboard.classList.add('hidden'); loginSection.classList.remove('hidden');
  }
});

/* ================= Firestore path ================= */
function getTxCollectionRef(){
  const comp=sanitizeId(companyInline.textContent || DEFAULT_COMPANY_TH);
  return db.collection('users').doc(currentUser.uid).collection('companies').doc(comp).collection('transactions');
}

/* ================= Load / Realtime ================= */
monthPicker.addEventListener('change', ()=>{
  localStorage.setItem('monthPicker', monthPicker.value);
  applyAndListen();
});

function applyAndListen(){
  if(!currentUser) return;

  if(unsubscribe){unsubscribe();unsubscribe=null;}
  const {start,end}=monthRange(monthPicker.value);
  periodLabel.textContent=`ช่วง ${start.toLocaleDateString('th-TH')} – ${new Date(end-1).toLocaleDateString('th-TH')}`;

  unsubscribe=getTxCollectionRef()
    .where('date','>=',start).where('date','<',end).orderBy('date','asc')
    .onSnapshot(snap=>{
      txCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderTable(); renderKPIs(); renderChart();
    }, err=>{
      alert('โหลดข้อมูลผิดพลาด: '+err.message+
        '\n\nถ้าเห็น code 403 ให้ตรวจ Firebase Security Rules/สิทธิ์ Firestore');
    });
}

/* ================= Detail form logic ================= */
detType.addEventListener('change', ()=>{
  if(detType.value==='expense'){ detExpenseWrap.classList.remove('hidden'); }
  else{ detExpenseWrap.classList.add('hidden'); detExpenseSubtype.value='ads'; }
});

/* Submit save */
detailForm.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(!currentUser) return;
  const data={
    uid:currentUser.uid,
    companyTH:companyInline.textContent, companyEN:companyInlineEn.textContent,
    date:new Date(detDate.value),
    orderCode: (detOrderCode.value||'').trim(),
    refNumber: (detRefNumber.value||'').trim(),
    productName:(detProduct.value||'').trim(),
    price: num(detPrice.value),
    shippingCost: num(detShipping.value),
    type: detType.value, // 'income' | 'expense'
    expenseSubtype: detType.value==='expense' ? detExpenseSubtype.value : '',
    note:(detNote.value||'').trim(),
    createdAt:new Date(), createdBy: currentUser.email||currentUser.uid
  };
  // basic validation
  if(!data.date || isNaN(data.price)){ detMsg.textContent='กรอกวันที่และราคาถูกต้องก่อน'; return; }

  detMsg.textContent='...กำลังบันทึก';
  try{
    await getTxCollectionRef().add(data);
    detMsg.textContent='บันทึกแล้ว ✓';
    // reset some fields
    detOrderCode.value=''; detRefNumber.value=''; detProduct.value=''; detNote.value='';
    detPrice.value=''; detShipping.value='0'; detType.value='income'; detExpenseWrap.classList.add('hidden');
    detDate.value = toLocalDateTimeInput(new Date());
    setTimeout(()=>detMsg.textContent='',1200);
  }catch(err){ detMsg.textContent='ผิดพลาด: '+err.message; }
});

/* ================= Table ================= */
searchBox.addEventListener('input', renderTable);
function renderTable(){
  const q=(searchBox.value||'').toLowerCase();
  const rows=txCache.filter(r=>{
    const hay=[r.productName,r.orderCode,r.refNumber,r.note,r.category].map(x=>(x||'').toLowerCase()).join(' ');
    return !q || hay.includes(q);
  });
  countLabel.textContent=`${rows.length} รายการ`;
  txBody.innerHTML=rows.map(r=>{
    const d=new Date(r.date?.seconds ? r.date.seconds*1000 : r.date);
    const price=priceOf(r), ship=shipOf(r);
    const total = (r.type==='expense' ? -(price+ship) : price);
    const subtype = (r.type==='expense' && r.expenseSubtype) ? r.expenseSubtype : '';
    return `<tr>
      <td>${d.toLocaleDateString('th-TH')}</td>
      <td>${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</td>
      <td>${r.type==='income'?'รายรับ':'รายจ่าย'}</td>
      <td>${r.productName||''}</td>
      <td class="right mono">${fmtBaht(price)}</td>
      <td class="right mono">${ship?fmtBaht(ship):'-'}</td>
      <td>${subtype||'-'}</td>
      <td>${r.orderCode||''}</td>
      <td>${r.refNumber||''}</td>
      <td class="right mono ${total>=0?'positive':'negative'}">${total>=0?'':'-'}${fmtBaht(Math.abs(total))}</td>
      <td>${r.note||''}</td>
      <td style="text-align:right"><button class="secondary outline" data-del="${r.id}">ลบ</button></td>
    </tr>`;
  }).join('');
  [...document.querySelectorAll('[data-del]')].forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('ต้องการลบรายการนี้?')) return;
      try{ await getTxCollectionRef().doc(btn.dataset.del).delete(); }
      catch(err){ alert('ลบไม่ได้: '+err.message); }
    });
  });
}

/* ================= KPIs ================= */
function renderKPIs(){
  let income=0, expense=0;
  txCache.forEach(r=>{
    if(r.type==='income'){ income += priceOf(r); }
    else{ expense += (priceOf(r) + shipOf(r)); }
  });
  const net = income - expense;
  kpiIncome.textContent=fmtBaht(income);
  kpiExpense.textContent=fmtBaht(expense);
  kpiNet.textContent=(net>=0?'':'-')+fmtBaht(Math.abs(net));
}

/* ================= Chart ================= */
function renderChart(){
  if(!monthPicker.value) return;
  const [yy,mm]=monthPicker.value.split('-').map(Number);
  const daysInMonth = new Date(yy, mm, 0).getDate();
  const labels=[...Array(daysInMonth)].map((_,i)=>String(i+1));
  const incomeDaily=Array(daysInMonth).fill(0), expenseDaily=Array(daysInMonth).fill(0);

  txCache.forEach(r=>{
    const d=new Date(r.date?.seconds ? r.date.seconds*1000 : r.date);
    const i=d.getDate()-1; if(i<0||i>=daysInMonth) return;
    if(r.type==='income') incomeDaily[i]+=priceOf(r);
    else expenseDaily[i]+=(priceOf(r)+shipOf(r));
  });

  const ctx=document.getElementById('dailyChart');
  if(window._dailyChart){ window._dailyChart.destroy(); }
  window._dailyChart=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[
      { label:'รายรับ', data:incomeDaily },
      { label:'รายจ่าย', data:expenseDaily }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'top' }}, scales:{ y:{ beginAtZero:true } } }
  });
}
</script>
</body>
</html>
